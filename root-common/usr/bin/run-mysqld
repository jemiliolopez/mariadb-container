#!/bin/bash

export_vars=$(cgroup-limits); export $export_vars
source ${CONTAINER_SCRIPTS_PATH}/common.sh
set -eu
if [[ -v DEBUG_IGNORE_SCRIPT_FAILURES ]]; then
  set +e
fi

export_setting_variables

log_volume_info $MYSQL_DATADIR

# pre-init files
process_extending_files ${APP_DATA}/mysql-pre-init/ ${CONTAINER_SCRIPTS_PATH}/pre-init/

if [ ! -d "$MYSQL_DATADIR/mysql" ]; then
  initialize_database "$@"
else
  start_local_mysql "$@"
fi

# init files
process_extending_files ${APP_DATA}/mysql-init/ ${CONTAINER_SCRIPTS_PATH}/init/

# Restart the MySQL server with public IP bindings
shutdown_local_mysql
unset_env_vars
log_volume_info $MYSQL_DATADIR
log_info 'Running final exec -- Only MySQL server logs after this point'


#/bin/bash /usr/libexec/s2i/run

#/opt/rh/rh-mariadb103/root/usr/libexec/mysqld --defaults-file=/etc/my.cnf --skip-networking --socket=/tmp/mysql.sock

# PLEASE REMEMBER TO SET A PASSWORD FOR THE MariaDB root USER !
# To do so, start the server, then issue the following commands:

# scl enable rh-mariadb103 -- '/opt/rh/rh-mariadb103/root/usr/bin/mysqladmin' -u root password 'new-password'
# scl enable rh-mariadb103 -- '/opt/rh/rh-mariadb103/root/usr/bin/mysqladmin' -u root -h is-1-mariadb-10-3-1-wgg25 password 'new-password'

# Alternatively you can run:
# scl enable rh-mariadb103 -- '/opt/rh/rh-mariadb103/root/usr/bin/mysql_secure_installation'

# exec /bin/bash -c "export MYSQL_PWD=${MYSQL_ROOT_PASSWORD} && ${MYSQL_PREFIX}/libexec/mysqld --defaults-file=$MYSQL_DEFAULTS_FILE $@ 2>&1"

# ${MYSQL_PREFIX}/libexec/mysqld --defaults-file=$MYSQL_DEFAULTS_FILE "$@" 2>&1
# scl enable rh-mariadb103 -- '/opt/rh/rh-mariadb103/root/usr/bin/mysqladmin' -u root password 'new-password'
# exec ${MYSQL_PREFIX}/libexec/mysqld -uroot -p  --defaults-file=$MYSQL_DEFAULTS_FILE "$@" 2>&1
# exec bash -c -i "${MYSQL_PREFIX}/libexec/mysqld  --defaults-file=$MYSQL_DEFAULTS_FILE $@ && mysql -uroot -e \"UPDATE mysql.user SET Password=PASSWORD('${MYSQL_ROOT_PASSWORD}') WHERE User='root'; FLUSH PRIVILEGES\""


# bash -c -i "exec ${MYSQL_PREFIX}/libexec/mysqld  --defaults-file=$MYSQL_DEFAULTS_FILE $@ && mysql -uroot -e \"UPDATE mysql.user SET Password=PASSWORD('${MYSQL_ROOT_PASSWORD}') WHERE User='root'; FLUSH PRIVILEGES\""

# echo "Esperemos que si ... >>> ${MY_PRUEBA}"

# source '/etc/environment'


trap 'echo "amigo mio" > /opt/app-root/src/mensaje' EXIT ERR
exec ${MYSQL_PREFIX}/libexec/mysqld --defaults-file=$MYSQL_DEFAULTS_FILE "$@" 2>&1
